---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: adguard-dns53-labeller
  namespace: network
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: adguard-dns53-labeller
rules:
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list", "watch", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: adguard-dns53-labeller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: adguard-dns53-labeller
subjects:
  - kind: ServiceAccount
    name: adguard-dns53-labeller
    namespace: network
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: adguard-dns53-labeller
  namespace: network
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: adguard-dns53-labeller
  template:
    metadata:
      labels:
        app.kubernetes.io/name: adguard-dns53-labeller
    spec:
      hostPID: true
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      serviceAccountName: adguard-dns53-labeller
      tolerations:
        - operator: Exists
      containers:
        - name: labeller
          image: bitnami/kubectl:1.29
          imagePullPolicy: IfNotPresent
          env:
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
          command:
            - /bin/sh
            - -c
            - |
              set -eu
              check() {
                busy_tcp=$(awk 'NR>1 && $2 ~ /:0035$/ && $4=="0A"{found=1} END{if(found) print "busy"}' /proc/net/tcp /proc/net/tcp6 2>/dev/null || true)
                busy_udp=$(awk 'NR>1 && $2 ~ /:0035$/{found=1} END{if(found) print "busy"}' /proc/net/udp /proc/net/udp6 2>/dev/null || true)
                if [ "${busy_tcp:-}${busy_udp:-}" = "" ]; then echo free; else echo busy; fi
              }
              while true; do
                if [ "$(check)" = free ]; then
                  kubectl label node "$NODE_NAME" adguard.sevendays.cloud/dns53-free=true --overwrite
                else
                  # remove label if present
                  kubectl label node "$NODE_NAME" adguard.sevendays.cloud/dns53-free- || true
                fi
                sleep 30
              done

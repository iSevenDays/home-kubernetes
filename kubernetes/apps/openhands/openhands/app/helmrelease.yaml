---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openhands
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: openhands
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  dependsOn:
    - name: cloudflare-tunnel
      namespace: network
  values:
    # The chart provides an Ingress resource but this cluster exposes
    # services via Gateway API HTTPRoutes.  We therefore disable the
    # built-in Ingress and create a separate HTTPRoute manifest (see
    # ../gateway/route.yaml.j2) that forwards external traffic.
    ingress:
      enabled: false
    tls:
      enabled: true
    postgresql:
      enabled: true
      auth:
        existingSecret: postgres-password
      primary:
        persistence:
          enabled: false # TODO: Enable this when we have a persistent volume
    redis:
      enabled: true
    sandbox:
      apiHostname: "https://runtime-api.${SECRET_DOMAIN}"
    litellm:
      url: "https://llm-proxy.${SECRET_DOMAIN}"
      # Injected from SOPS-encrypted secret rendered from templates
      teamId: "${LITELLM_TEAM_ID}"
    litellm-helm:
      enabled: true
      db:
        endpoint: "openhands-postgresql"
        deployStandalone: false
        useExisting: true
      environmentSecrets:
        - litellm-env-secrets
      ingress:
        enabled: false  # port-forward initially
      masterkeySecretName: lite-llm-api-key
      masterkeySecretKey: lite-llm-api-key
      proxy_config:
        model_list:
          - model_name: "${litellm_model}"
            litellm_params:
              model: "${litellm_model}"
              api_base: "${litellm_base_url}"
              api_key: "${litellm_api_key}"
              timeout: ${litellm_timeout}
              max_tokens: ${litellm_max_output_tokens}
    runtime-api:
      enabled: true
      env:
        DB_HOST: "openhands-postgresql"
    podAnnotations:
      secret.reloader.stakater.com/reload: |
        sandbox-api-key,postgres-password,redis,jwt-secret,
        lite-llm-api-key,keycloak-realm,keycloak-admin,litellm-env-secrets
